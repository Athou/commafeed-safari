<!DOCTYPE HTML>
<script src="jquery-1.9.1.min.js"></script>
<script>
safari.application.addEventListener("command", performCommand, false);
safari.extension.settings.addEventListener("change", settingChanged, false);

var timer = null;

function settingChanged(event){
	if (event.key == "updateTime") {
		clearTimeout(timer);
		getUnreadCount();
	}
}

function performCommand(event) {
    if (event.command == "open-commafeed") {
		var newTab = safari.application.activeBrowserWindow.openTab();
		newTab.url = "https://commafeed.com/";
    }
}

function updateUnreadCount(data){
	var sum = 0;
	for(var i=0;i<data.length;i++){
		sum+=data[i].unreadCount;
	}
	safari.extension.toolbarItems[0].badge=sum;
}

function getUnreadCount(){
	$.ajax({
		url: "https://www.commafeed.com/rest/category/unreadCount",
		dataType: "json",
		success: updateUnreadCount
	});
	
	timer = setTimeout(getUnreadCount,safari.extension.settings.updateTime);
}


getUnreadCount();
</script>